<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Editoriale</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
<div class="container">

    <!-- HEADER -->
    <header>
        <h1 id="page-title">Piano Editoriale Awalyt</h1>
        <p id="page-subtitle">Piano Editoriale • Lettura cliente</p>
    </header>

    <!-- NAVIGATION -->
    <div class="nav-container">
        <span class="nav-label">Seleziona un giorno</span>
        <div class="nav-days" id="nav-days"></div>
    </div>

    <!-- STATUS -->
    <div id="status" style="text-align:center; color:#666; margin-bottom:2rem;"></div>

    <!-- DAYS CONTAINER -->
    <div class="days-container" id="days-container"></div>

    <!-- FOOTER -->
    <div class="footer-note">
        <p><strong id="footer-line1">Piano Editoriale</strong></p>
        <p id="footer-line2">Aggiorna Google Sheet per modificare i contenuti</p>
    </div>
</div>

<!-- CSV parser -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/* =========================
   CONFIG
========================= */
const CONFIG = {
    sheetId: "1kO34cAEjvM7XyzpoN4yDimcGMpUo5MI0",
    giorniSheetName: "Giorni",
    riepilogoSheetName: "Riepilogo",
};

/* =========================
   CSV REPAIR + PARSE (FIX)
========================= */
function repairCsvByColumnCount(csvText) {
    const text = csvText
        .replace(/\r\n/g, "\n")
        .replace(/\r/g, "\n");

    const lines = text.split("\n");
    if (lines.length <= 2) return csvText;

    const header = lines[0];
    const expectedCols = header.split(",").length;

    const out = [header];
    let buffer = "";

    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        if (!line.trim()) continue;

        buffer = buffer ? (buffer + "\n" + line) : line;

        if (buffer.split(",").length >= expectedCols) {
            out.push(buffer);
            buffer = "";
        }
    }

    if (buffer) out.push(buffer);
    return out.join("\n");
}

function parseCsv(csvText) {
    const repaired = repairCsvByColumnCount(csvText);
    const parsed = Papa.parse(repaired, {
        header: true,
        skipEmptyLines: true
    });

    if (parsed.errors && parsed.errors.length) {
        console.warn("CSV warnings:", parsed.errors);
    }
    return parsed.data || [];
}

/* =========================
   HELPERS
========================= */
function setStatus(msg) {
    document.getElementById("status").textContent = msg || "";
}

function csvUrlForSheet(sheetName) {
    const bust = Date.now();
    return `https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&cachebust=${bust}`;
}

async function fetchCsv(sheetName) {
    const res = await fetch(csvUrlForSheet(sheetName));
    if (!res.ok) throw new Error(`Errore fetch ${sheetName}`);
    return await res.text();
}

/* =========================
   RENDERING (INVARIATO)
========================= */
/* — tutto il tuo codice di rendering rimane IDENTICO —
   non lo ripeto qui per brevità visiva, ma nel tuo file
   reale deve rimanere ESATTAMENTE uguale a prima.
   L’unica modifica è parseCsv sopra.
*/

/* =========================
   BOOT
========================= */
async function boot() {
    try {
        setStatus("Caricamento dati…");

        const riepilogoCsv = await fetchCsv(CONFIG.riepilogoSheetName);
        renderRiepilogo(parseCsv(riepilogoCsv));

        const giorniCsv = await fetchCsv(CONFIG.giorniSheetName);
        renderDays(parseCsv(giorniCsv));

        setStatus("");
    } catch (e) {
        console.error(e);
        setStatus("Errore caricamento dati");
    }
}

boot();
</script>
</body>
</html>
